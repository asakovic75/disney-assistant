import streamlit as st
import pandas as pd
from openai import OpenAI
import os

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
st.set_page_config(page_title="–ü–∏–∫—Å–µ–ª—å", page_icon="‚ú®", layout="wide")

# --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ CSS —Å—Ç–∏–ª–µ–π ---
def local_css(file_name):
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤–Ω–µ—à–Ω–∏–π CSS-—Ñ–∞–π–ª –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."""
    try:
        with open(file_name, "r", encoding="utf-8") as f:
            st.markdown(f"<style>{f.read()}</style>", unsafe_allow_html=True)
    except FileNotFoundError:
        st.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω —Ñ–∞–π–ª —Å—Ç–∏–ª–µ–π '{file_name}'!")

# –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∏–∑ —Ñ–∞–π–ª–∞ style.css
local_css("style.css")


# --- –ü–æ–ª—É—á–µ–Ω–∏–µ API –∫–ª—é—á–∞ –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤ Streamlit ---
GROQ_API_KEY = os.getenv("GROQ_API_KEY")

# --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π ---
@st.cache_data
def create_knowledge_base():
    """–ß–∏—Ç–∞–µ—Ç CSV-—Ñ–∞–π–ª –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –µ–≥–æ –≤ –µ–¥–∏–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è AI-–º–æ–¥–µ–ª–∏."""
    try:
        works_df = pd.read_csv("–ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è–ü.csv").astype(str).fillna('–Ω–µ —É–∫–∞–∑–∞–Ω–æ')
        knowledge_base = ""
        for _, work in works_df.iterrows():
            knowledge_base += "-----\n"
            knowledge_base += f"–ù–∞–∑–≤–∞–Ω–∏–µ: {work['Name']}\n"
            knowledge_base += f"–ë—é–¥–∂–µ—Ç –∏ —Å–±–æ—Ä—ã: {work.get('–ë—é–¥–∂–µ—Ç –∏ —Å–±–æ—Ä—ã', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            knowledge_base += f"–í–æ–∑—Ä–∞—Å—Ç: {work.get('–í–æ–∑—Ä–∞—Å—Ç', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            knowledge_base += f"–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞: {work.get('–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            knowledge_base += f"–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏: {work.get('–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            knowledge_base += f"–ù–∞–≥—Ä–∞–¥—ã: {work.get('–ù–∞–≥—Ä–∞–¥—ã', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            knowledge_base += f"–ü–µ—Ä—Å–æ–Ω–∞–∂–∏: {work.get('–ü–µ—Ä—Å–æ–Ω–∞–∂–∏', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            knowledge_base += f"–ü–µ—Å–Ω–∏: {work.get('–ü–µ—Å–Ω–∏', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            knowledge_base += f"–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {work.get('–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            knowledge_base += f"–†–µ–π—Ç–∏–Ω–≥: {work.get('–†–µ–π—Ç–∏–Ω–≥', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            knowledge_base += f"–°—Ç—É–¥–∏—è: {work.get('–°—Ç—É–¥–∏—è', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            knowledge_base += f"–¢–∏–ø: {work.get('–¢–∏–ø', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
        return knowledge_base
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö: {e}")
        return None

# === –ù–∞—á–∞–ª–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ===

st.title("‚ú® –£–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç")
st.markdown("### –£–∑–Ω–∞–π—Ç–µ –≤—Å—ë –æ –ª—é–±–∏–º—ã—Ö —Ñ–∏–ª—å–º–∞—Ö –∏ –º—É–ª—å—Ç—Ñ–∏–ª—å–º–∞—Ö!")
st.markdown("---")

# --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ –ø–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ ---
user_query = st.text_input(
    label=" ",  # –ü—É—Å—Ç–∞—è –º–µ—Ç–∫–∞, —á—Ç–æ–±—ã –µ–µ —Å–∫—Ä—ã—Ç—å
    placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å –∑–¥–µ—Å—å...",
    key="user_input_box",
    label_visibility="collapsed"
)

st.markdown("<div style='margin-bottom: 2rem;'></div>", unsafe_allow_html=True)

ask_button = st.button("**–ù–ê–ô–¢–ò –û–¢–í–ï–¢**", use_container_width=True, key="find_answer")

# –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
knowledge_base_text = create_knowledge_base()
# –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∫—É–¥–∞ –ø–æ–∑–∂–µ –≤—ã–≤–µ–¥–µ–º –æ—Ç–≤–µ—Ç
answer_placeholder = st.empty()

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ
if knowledge_base_text and GROQ_API_KEY:
    try:
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ AI-–º–æ–¥–µ–ª–∏
        client = OpenAI(base_url="https://api.groq.com/openai/v1", api_key=GROQ_API_KEY)
        model_name = "meta-llama/llama-4-scout-17b-16e-instruct"
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞: {e}")
        client = None

    # –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞: –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –µ—Å–ª–∏ –µ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç, –µ—Å—Ç—å –∑–∞–ø—Ä–æ—Å –∏ –Ω–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞
    if client and user_query and ask_button:
        with st.spinner(""):
            st.markdown("<div class='spinner-text'>‚ú® –ò—â—É –æ—Ç–≤–µ—Ç –≤ –≤–æ–ª—à–µ–±–Ω—ã—Ö –∞—Ä—Ö–∏–≤–∞—Ö –î–∏—Å–Ω–µ–π...</div>", unsafe_allow_html=True)
            try:
                # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç (–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é) –¥–ª—è AI-–º–æ–¥–µ–ª–∏
                prompt = f"""–¢–≤–æ—è —Ä–æ–ª—å - –±—ã—Ç—å —Å–≤–µ—Ä—Ö-—Ç–æ—á–Ω—ã–º –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º-–±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ñ–∏–ª—å–º–∞–º Disney.

–°–¢–†–û–ì–ò–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò:
1.  **–ù–ò–ö–ê–ö–ò–• –î–û–ì–ê–î–û–ö:** –û—Ç–≤–µ—á–∞–π –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –Ω–∏–∂–µ "–î–∞–Ω–Ω—ã—Ö".
2.  **–ï–°–õ–ò –î–ê–ù–ù–´–• –ù–ï–¢:** –ï—Å–ª–∏ –≤ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞, —Ç–≤–æ–π –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —ç—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –∞—Ä—Ö–∏–≤–µ."
3.  **–†–ê–ó–õ–ò–ß–ê–ô –¢–ò–ü–´ (–°–ê–ú–û–ï –í–ê–ñ–ù–û–ï –ü–†–ê–í–ò–õ–û):** –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ "—Ñ–∏–ª—å–º", —Ç—ã –û–ë–Ø–ó–ê–ù –∏—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å—Ä–µ–¥–∏ –∑–∞–ø–∏—Å–µ–π —Å `–¢–∏–ø: –§–∏–ª—å–º` –∏ –ü–û–õ–ù–û–°–¢–¨–Æ –ò–ì–ù–û–†–ò–†–û–í–ê–¢–¨ –≤—Å–µ –º—É–ª—å—Ç—Ñ–∏–ª—å–º—ã. –ò –Ω–∞–æ–±–æ—Ä–æ—Ç. –í —Ç–≤–æ–∏—Ö —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è—Ö –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¢–û–õ–¨–ö–û —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ç–∏–ø—ã.
4.  **–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û):** –¢–≤–æ–π –æ—Ç–≤–µ—Ç –î–û–õ–ñ–ï–ù —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ –¥–≤—É—Ö –±–ª–æ–∫–æ–≤: `[–†–ê–°–°–£–ñ–î–ï–ù–ò–Ø]` –∏ `[–û–¢–í–ï–¢]`.
    -   **–í –±–ª–æ–∫–µ `[–†–ê–°–°–£–ñ–î–ï–ù–ò–Ø]`:** –°–Ω–∞—á–∞–ª–∞ **–ø—Ä–æ—Ü–∏—Ç–∏—Ä—É–π –≤—Å–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ (—É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ!) –∑–∞–ø–∏—Å–∏ –∏–∑ '–î–∞–Ω–Ω—ã—Ö'**. –ó–∞—Ç–µ–º, –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–∏—Ö —Ü–∏—Ç–∞—Ç, —Å–¥–µ–ª–∞–π –∫—Ä–∞—Ç–∫–∏–π –ª–æ–≥–∏—á–µ—Å–∫–∏–π –≤—ã–≤–æ–¥.
    -   **–í –±–ª–æ–∫–µ `[–û–¢–í–ï–¢]`:** –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π, —á–∏—Å—Ç—ã–π –æ—Ç–≤–µ—Ç. **–ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Å–ø–∏—Å–æ–∫, –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–π –µ–≥–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É—è –¥–µ—Ñ–∏—Å (-) –∏ –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞.**

–ü–†–ò–ú–ï–† ‚Ññ1 (–ø—Ä–æ—Å—Ç–æ–π –æ—Ç–≤–µ—Ç):
[–†–ê–°–°–£–ñ–î–ï–ù–ò–Ø]
–í–æ–ø—Ä–æ—Å –∫–∞—Å–∞–µ—Ç—Å—è –±—é–¥–∂–µ—Ç–∞ '–ö–æ—Ä–æ–ª—è –õ—å–≤–∞'. –Ø –Ω–∞—à–µ–ª —Å–ª–µ–¥—É—é—â—É—é –∑–∞–ø–∏—Å—å:
-----
–ù–∞–∑–≤–∞–Ω–∏–µ: –ö–æ—Ä–æ–ª—å –ª–µ–≤
–ë—é–¥–∂–µ—Ç –∏ —Å–±–æ—Ä—ã: $45 –º–ª–Ω / $968 –º–ª–Ω
–ò–∑ —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏ –≤–∏–¥–Ω–æ, —á—Ç–æ –±—é–¥–∂–µ—Ç —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç $45 –º–ª–Ω.
[–û–¢–í–ï–¢]
–ë—é–¥–∂–µ—Ç –º—É–ª—å—Ç—Ñ–∏–ª—å–º–∞ "–ö–æ—Ä–æ–ª—å –ª–µ–≤" —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç $45 –º–ª–Ω.

–ü–†–ò–ú–ï–† ‚Ññ2 (–æ—Ç–≤–µ—Ç —Å–ø–∏—Å–∫–æ–º):
[–†–ê–°–°–£–ñ–î–ï–ù–ò–Ø]
–í–æ–ø—Ä–æ—Å –æ —Ñ–∏–ª—å–º–∞—Ö 2019 –≥–æ–¥–∞. –Ø –Ω–∞—à–µ–ª —Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏ —Å `–¢–∏–ø: –§–∏–ª—å–º` –∏ `–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞: 2019`:
-----
–ù–∞–∑–≤–∞–Ω–∏–µ: –ö–æ—Ä–æ–ª—å –õ–µ–≤: –ù–æ–≤–∞—è –≥–ª–∞–≤–∞
–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞: 2019
–¢–∏–ø: –§–∏–ª—å–º
-----
–ù–∞–∑–≤–∞–Ω–∏–µ: –ê–ª–∞–¥–¥–∏–Ω: –ù–æ–≤–æ–µ –∂–µ–ª–∞–Ω–∏–µ
–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞: 2019
–¢–∏–ø: –§–∏–ª—å–º
–Ø –Ω–∞—à–µ–ª –¥–≤–∞ —Ñ–∏–ª—å–º–∞, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –∫—Ä–∏—Ç–µ—Ä–∏—è–º.
[–û–¢–í–ï–¢]
–§–∏–ª—å–º—ã, –≤—ã–ø—É—â–µ–Ω–Ω—ã–µ –≤ 2019 –≥–æ–¥—É:
- –ö–æ—Ä–æ–ª—å –õ–µ–≤: –ù–æ–≤–∞—è –≥–ª–∞–≤–∞
- –ê–ª–∞–¥–¥–∏–Ω: –ù–æ–≤–æ–µ –∂–µ–ª–∞–Ω–∏–µ

–î–ê–ù–ù–´–ï:
{knowledge_base_text}

–í–û–ü–†–û–°: {user_query}

–û–¢–í–ï–¢ –í –°–¢–†–û–ì–û–ú –§–û–†–ú–ê–¢–ï:"""

                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ AI-–º–æ–¥–µ–ª–∏
                response = client.chat.completions.create(
                    model=model_name,
                    messages=[{"role": "user", "content": prompt}],
                    temperature=0.1,
                    max_tokens=2000
                )
                answer = response.choices[0].message.content

                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞
                try:
                    reasoning_part, final_answer_part = answer.split("[–û–¢–í–ï–¢]")
                    reasoning_text = reasoning_part.replace("[–†–ê–°–°–£–ñ–î–ï–ù–ò–Ø]", "").strip()
                    final_answer_text = final_answer_part.strip()
                    
                    reasoning_html = reasoning_text.replace('\n', '<br>')
                    final_answer_html = final_answer_text.replace('\n', '<br>')

                    full_response_html = f"{reasoning_html}<br><br><hr><br><strong>{final_answer_html}</strong>"
                except ValueError:
                    full_response_html = answer.replace("[–†–ê–°–°–£–ñ–î–ï–ù–ò–Ø]", "").replace("[–û–¢–í–ï–¢]", "").replace('\n', '<br>').strip()

                # –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
                answer_placeholder.markdown(f'<div class="big-success-message">üéâ –ì–û–¢–û–í–û! –í–æ—Ç —á—Ç–æ –º–Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏:</div>', unsafe_allow_html=True)
                st.markdown(f'<div class="user-question">–í–∞—à –≤–æ–ø—Ä–æ—Å: {user_query}</div>', unsafe_allow_html=True)
                st.markdown("---")
                st.markdown(f'<div class="big-answer-text">{full_response_html}</div>', unsafe_allow_html=True)

            except Exception as e:
                answer_placeholder.markdown(f'<div class="big-error-message">‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}</div>', unsafe_allow_html=True)
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É, –Ω–æ –Ω–µ –≤–≤–µ–ª –≤–æ–ø—Ä–æ—Å
    elif not user_query and ask_button:
        answer_placeholder.markdown('<div class="big-warning-message">‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å!</div>', unsafe_allow_html=True)
