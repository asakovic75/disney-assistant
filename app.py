import streamlit as st
import pandas as pd
from openai import OpenAI
import os

st.set_page_config(page_title="–£–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç", page_icon="‚ú®", layout="wide")


def local_css(file_name):
    try:
        with open(file_name, "r", encoding="utf-8") as f:
            st.markdown(f"<style>{f.read()}</style>", unsafe_allow_html=True)
    except FileNotFoundError:
        st.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω —Ñ–∞–π–ª —Å—Ç–∏–ª–µ–π style.css!")


GROQ_API_KEY = os.getenv("GROQ_API_KEY")


@st.cache_data
def create_knowledge_base():
    try:
        works_df = pd.read_csv("–ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è–ü.csv").astype(str).fillna('–Ω–µ —É–∫–∞–∑–∞–Ω–æ')
        knowledge_base = ""
        for _, work in works_df.iterrows():
            knowledge_base += "-----\n"
            knowledge_base += f"–ù–∞–∑–≤–∞–Ω–∏–µ: {work['Name']}\n"
            knowledge_base += f"–ë—é–¥–∂–µ—Ç –∏ —Å–±–æ—Ä—ã: {work.get('–ë—é–¥–∂–µ—Ç –∏ —Å–±–æ—Ä—ã', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            knowledge_base += f"–í–æ–∑—Ä–∞—Å—Ç: {work.get('–í–æ–∑—Ä–∞—Å—Ç', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            knowledge_base += f"–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞: {work.get('–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            knowledge_base += f"–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏: {work.get('–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            knowledge_base += f"–ù–∞–≥—Ä–∞–¥—ã: {work.get('–ù–∞–≥—Ä–∞–¥—ã', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            knowledge_base += f"–ü–µ—Ä—Å–æ–Ω–∞–∂–∏: {work.get('–ü–µ—Ä—Å–æ–Ω–∞–∂–∏', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            knowledge_base += f"–ü–µ—Å–Ω–∏: {work.get('–ü–µ—Å–Ω–∏', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            knowledge_base += f"–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {work.get('–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            knowledge_base += f"–†–µ–π—Ç–∏–Ω–≥: {work.get('–†–µ–π—Ç–∏–Ω–≥', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            knowledge_base += f"–°—Ç—É–¥–∏—è: {work.get('–°—Ç—É–¥–∏—è', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            knowledge_base += f"–¢–∏–ø: {work.get('–¢–∏–ø', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
        return knowledge_base
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö: {e}")
        return None


local_css("style.css")

st.title("–£–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç")
st.markdown("### –£–∑–Ω–∞–π—Ç–µ –≤—Å—ë –æ –ª—é–±–∏–º—ã—Ö —Ñ–∏–ª—å–º–∞—Ö –∏ –º—É–ª—å—Ç—Ñ–∏–ª—å–º–∞—Ö!")

example_questions = [
    "–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–∑ —Å–ø–∏—Å–∫–∞...", "–ö–∞–∫–æ–π –±—é–¥–∂–µ—Ç —É —Ñ–∏–ª—å–º–∞ '–ñ–µ–ª–µ–∑–Ω—ã–π —á–µ–ª–æ–≤–µ–∫'?", "–ö–∞–∫–∏–µ —Å–±–æ—Ä—ã —É –º—É–ª—å—Ç—Ñ–∏–ª—å–º–∞ '–•–æ–ª–æ–¥–Ω–æ–µ —Å–µ—Ä–¥—Ü–µ'?",
    "–ö–∞–∫–æ–π —Ñ–∏–ª—å–º —Å–∞–º—ã–π –∫–∞—Å—Å–æ–≤—ã–π?", "–°—Ä–∞–≤–Ω–∏ –±—é–¥–∂–µ—Ç—ã '–ò—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä—É—à–µ–∫' –∏ '–ò—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä—É—à–µ–∫ 4'.", "–í –∫–∞–∫–æ–º –≥–æ–¥—É –≤—ã—à–µ–ª –º—É–ª—å—Ç—Ñ–∏–ª—å–º '–ë–µ–ª–æ—Å–Ω–µ–∂–∫–∞ –∏ —Å–µ–º—å –≥–Ω–æ–º–æ–≤'?",
    "–ö–∞–∫–∏–µ —Ñ–∏–ª—å–º—ã –≤—ã—à–ª–∏ –≤ 2019 –≥–æ–¥—É?", "–ö–∞–∫–æ–π —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π –º—É–ª—å—Ç—Ñ–∏–ª—å–º –≤ –±–∞–∑–µ?", "–í –∫–∞–∫–æ–º –î–∏—Å–Ω–µ–π–ª–µ–Ω–¥–µ –µ—Å—Ç—å –∞—Ç—Ç—Ä–∞–∫—Ü–∏–æ–Ω –ø–æ '–ü–∏—Ä–∞—Ç–∞–º –ö–∞—Ä–∏–±—Å–∫–æ–≥–æ –º–æ—Ä—è'?",
    "–ö–∞–∫–∏–µ –∞—Ç—Ç—Ä–∞–∫—Ü–∏–æ–Ω—ã –µ—Å—Ç—å –≤ Magic Kingdom?", "–ö–∞–∫–æ–π –∂–∞–Ω—Ä —É —Ñ–∏–ª—å–º–∞ '–ö—Ä—É—ç–ª–ª–∞'?", "–ü–µ—Ä–µ—á–∏—Å–ª–∏ –≤—Å–µ —Ñ–∏–ª—å–º—ã –≤ –∂–∞–Ω—Ä–µ '–ú—å—é–∑–∏–∫–ª'.",
    "–í –∫–∞–∫–∏—Ö —Ñ–∏–ª—å–º–∞—Ö —Å–Ω–∏–º–∞–ª—Å—è –î–∂–æ–Ω–Ω–∏ –î–µ–ø–ø?", "–ö–∞–∫–∏–µ –∞–∫—Ç–µ—Ä—ã –±—ã–ª–∏ –≤ —Ñ–∏–ª—å–º–µ '–ü–∏—Ä–∞—Ç—ã –ö–∞—Ä–∏–±—Å–∫–æ–≥–æ –º–æ—Ä—è: –ü—Ä–æ–∫–ª—è—Ç–∏–µ –ß—ë—Ä–Ω–æ–π –∂–µ–º—á—É–∂–∏–Ω—ã'?",
    "–ö–∞–∫–∏–µ –Ω–∞–≥—Ä–∞–¥—ã –ø–æ–ª—É—á–∏–ª –º—É–ª—å—Ç—Ñ–∏–ª—å–º '–ö–æ—Ä–æ–ª—å –ª–µ–≤' 1994 –≥–æ–¥–∞?", "–ö–∞–∫–æ–π —Ñ–∏–ª—å–º –ø–æ–ª—É—á–∏–ª '–û—Å–∫–∞—Ä' –∑–∞ –ª—É—á—à–∏–µ –∫–æ—Å—Ç—é–º—ã?", "–£ –∫–∞–∫–æ–≥–æ —Ñ–∏–ª—å–º–∞ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ '–û—Å–∫–∞—Ä–æ–≤'?",
    "–ö–∞–∫–∏–µ –≥–ª–∞–≤–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –≤ '–†—É—Å–∞–ª–æ—á–∫–µ'?", "–í –∫–∞–∫–æ–º —Ñ–∏–ª—å–º–µ –µ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂ –ú–∞–ª–µ—Ñ–∏—Å–µ–Ω—Ç–∞?", "–ö–∞–∫–∏–µ –ø–µ—Å–Ω–∏ –µ—Å—Ç—å –≤ –º—É–ª—å—Ç—Ñ–∏–ª—å–º–µ '–ö–æ—Ä–æ–ª—å –ª–µ–≤'?",
    "–ö–∞–∫–∏–µ –ø–µ—Å–Ω–∏ –≤ '–•–æ–ª–æ–¥–Ω–æ–º —Å–µ—Ä–¥—Ü–µ'?", "–í –∫–∞–∫–æ–º –º—É–ª—å—Ç—Ñ–∏–ª—å–º–µ –∑–≤—É—á–∏—Ç –ø–µ—Å–Ω—è 'A Whole New World'?", "–ö–∞–∫–∞—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É —Ñ–∏–ª—å–º–∞ '–ü–∏—Ä–∞—Ç—ã –ö–∞—Ä–∏–±—Å–∫–æ–≥–æ –º–æ—Ä—è: –ù–∞ –∫—Ä–∞—é —Å–≤–µ—Ç–∞'?",
    "–ö–∞–∫–æ–π —Å–∞–º—ã–π –¥–ª–∏–Ω–Ω—ã–π —Ñ–∏–ª—å–º –≤ —Å–ø–∏—Å–∫–µ?", "–ö–∞–∫–æ–π —Å–∞–º—ã–π –∫–æ—Ä–æ—Ç–∫–∏–π –º—É–ª—å—Ç—Ñ–∏–ª—å–º?", "–ö–∞–∫–æ–π —Ä–µ–π—Ç–∏–Ω–≥ —É '–ò—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä—É—à–µ–∫'?", "–ö–∞–∫–æ–π —Ñ–∏–ª—å–º –∏–º–µ–µ—Ç —Å–∞–º—ã–π –≤—ã—Å–æ–∫–∏–π —Ä–µ–π—Ç–∏–Ω–≥?",
    "–ö–∞–∫–∏–µ –º—É–ª—å—Ç—Ñ–∏–ª—å–º—ã —Å–¥–µ–ª–∞–ª–∞ —Å—Ç—É–¥–∏—è Pixar?", "–ö–∞–∫–∞—è —Å—Ç—É–¥–∏—è –≤—ã–ø—É—Å—Ç–∏–ª–∞ —Ñ–∏–ª—å–º '–ñ–µ–ª–µ–∑–Ω—ã–π —á–µ–ª–æ–≤–µ–∫'?", "–ü–µ—Ä–µ—á–∏—Å–ª–∏ –≤—Å–µ –∏–≥—Ä–æ–≤—ã–µ —Ñ–∏–ª—å–º—ã (–Ω–µ –º—É–ª—å—Ç—Ñ–∏–ª—å–º—ã)."
]

st.markdown("---")

selected_query = st.selectbox(" ", example_questions, key="selectbox_query", label_visibility="collapsed")
custom_query = st.text_input(" ", placeholder="–ò–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å –∑–¥–µ—Å—å...", label_visibility="collapsed", key="text_input")

st.markdown("<div style='margin-bottom: 5rem;'></div>", unsafe_allow_html=True)

ask_button = st.button("**–ù–ê–ô–¢–ò –û–¢–í–ï–¢**", use_container_width=True, key="find_answer")

if custom_query.strip(): user_query = custom_query
elif selected_query and selected_query != "–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–∑ —Å–ø–∏—Å–∫–∞...": user_query = selected_query
else: user_query = ""

knowledge_base_text = create_knowledge_base()
answer_placeholder = st.empty()

if knowledge_base_text and GROQ_API_KEY:
    try:
        client = OpenAI(base_url="https://api.groq.com/openai/v1", api_key=GROQ_API_KEY)
        model_name = "meta-llama/llama-4-scout-17b-16e-instruct"
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞: {e}")
        client = None

    if client and user_query and ask_button:
        with st.spinner(""):
            st.markdown("<div class='spinner-text'>‚ú® –ò—â—É –æ—Ç–≤–µ—Ç –≤ –≤–æ–ª—à–µ–±–Ω—ã—Ö –∞—Ä—Ö–∏–≤–∞—Ö –î–∏—Å–Ω–µ–π...</div>", unsafe_allow_html=True)
            try:
                prompt = f"""–¢–≤–æ—è —Ä–æ–ª—å - –±—ã—Ç—å —Å–≤–µ—Ä—Ö-—Ç–æ—á–Ω—ã–º –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º-–±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ñ–∏–ª—å–º–∞–º Disney.

–°–¢–†–û–ì–ò–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò:
1.  **–ù–ò–ö–ê–ö–ò–• –î–û–ì–ê–î–û–ö:** –û—Ç–≤–µ—á–∞–π –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –Ω–∏–∂–µ "–î–∞–Ω–Ω—ã—Ö".
2.  **–ï–°–õ–ò –î–ê–ù–ù–´–• –ù–ï–¢:** –ï—Å–ª–∏ –≤ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞, —Ç–≤–æ–π –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —ç—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –∞—Ä—Ö–∏–≤–µ."
3.  **–†–ê–ó–õ–ò–ß–ê–ô –¢–ò–ü–´:** –í –±–∞–∑–µ –µ—Å—Ç—å `–¢–∏–ø: –§–∏–ª—å–º` (–∏–≥—Ä–æ–≤–æ–µ –∫–∏–Ω–æ) –∏ `–¢–∏–ø: –ú—É–ª—å—Ç—Ñ–∏–ª—å–º` (–∞–Ω–∏–º–∞—Ü–∏—è). –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ "—Ñ–∏–ª—å–º", –∏—â–∏ —Ç–æ–ª—å–∫–æ —Å—Ä–µ–¥–∏ –∑–∞–ø–∏—Å–µ–π —Å `–¢–∏–ø: –§–∏–ª—å–º`. –ï—Å–ª–∏ –ø—Ä–æ "–º—É–ª—å—Ç—Ñ–∏–ª—å–º" ‚Äî —Ç–æ–ª—å–∫–æ —Å `–¢–∏–ø: –ú—É–ª—å—Ç—Ñ–∏–ª—å–º`. –ë—É–¥—å –ø—Ä–µ–¥–µ–ª—å–Ω–æ –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω –∫ —ç—Ç–æ–º—É —Ä–∞–∑–ª–∏—á–µ–Ω–∏—é.
4.  **–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û):** –¢–≤–æ–π –æ—Ç–≤–µ—Ç –î–û–õ–ñ–ï–ù —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ –¥–≤—É—Ö –±–ª–æ–∫–æ–≤: `[–†–ê–°–°–£–ñ–î–ï–ù–ò–Ø]` –∏ `[–û–¢–í–ï–¢]`.
    -   **–í –±–ª–æ–∫–µ `[–†–ê–°–°–£–ñ–î–ï–ù–ò–Ø]`:** –°–Ω–∞—á–∞–ª–∞ **–ø—Ä–æ—Ü–∏—Ç–∏—Ä—É–π –≤—Å–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –∏–∑ '–î–∞–Ω–Ω—ã—Ö'**. –ó–∞—Ç–µ–º, –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–∏—Ö —Ü–∏—Ç–∞—Ç, —Å–¥–µ–ª–∞–π –∫—Ä–∞—Ç–∫–∏–π –ª–æ–≥–∏—á–µ—Å–∫–∏–π –≤—ã–≤–æ–¥. –ù–µ –¥–æ–±–∞–≤–ª—è–π –ª–∏—à–Ω–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.
    -   **–í –±–ª–æ–∫–µ `[–û–¢–í–ï–¢]`:** –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π, —á–∏—Å—Ç—ã–π –æ—Ç–≤–µ—Ç –≤ –≤–∏–¥–µ –ø—Ä–æ—Å—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ –∞–±–∑–∞—Ü–∞. **–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ø–∏—Å–∫–∏, –º–∞—Ä–∫–µ—Ä—ã –∏–ª–∏ –∑–≤–µ–∑–¥–æ—á–∫–∏ (*).**

–î–ê–ù–ù–´–ï:
{knowledge_base_text}

–í–û–ü–†–û–°: {user_query}

–û–¢–í–ï–¢ –í –°–¢–†–û–ì–û–ú –§–û–†–ú–ê–¢–ï:"""

                response = client.chat.com_completions.create(
                    model=model_name,
                    messages=[{"role": "user", "content": prompt}],
                    temperature=0.1,
                    max_tokens=2000
                )
                answer = response.choices[0].message.content

                try:
                    reasoning_part, final_answer_part = answer.split("[–û–¢–í–ï–¢]")
                    reasoning_text = reasoning_part.replace("[–†–ê–°–°–£–ñ–î–ï–ù–ò–Ø]", "").strip()
                    final_answer_text = final_answer_part.strip()
                    
                    full_response = f"{reasoning_text}\n\n---\n\n–ú–æ–π –æ—Ç–≤–µ—Ç: **{final_answer_text}**"
                except ValueError:
                    full_response = answer.replace("[–†–ê–°–°–£–ñ–î–ï–ù–ò–Ø]", "").replace("[–û–¢–í–ï–¢]", "").strip()

                answer_placeholder.markdown(f'<div class="big-success-message">üéâ –ì–û–¢–û–í–û! –í–æ—Ç —á—Ç–æ –º–Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏:</div>', unsafe_allow_html=True)
                st.markdown(f'<div class="user-question">–í–∞—à –≤–æ–ø—Ä–æ—Å: {user_query}</div>', unsafe_allow_html=True)
                st.markdown("---")

                st.markdown(f'<div class="big-answer-text">{full_response}</div>', unsafe_allow_html=True)

            except Exception as e:
                answer_placeholder.markdown(f'<div class="big-error-message">‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}</div>', unsafe_allow_html=True)
    elif not user_query and ask_button:
        answer_placeholder.markdown('<div class="big-warning-message">‚ö†Ô∏è –ü–û–ñ–ê–õ–£–ô–°–¢–ê, –í–´–ë–ï–†–ò–¢–ï –í–û–ü–†–û–° –ò–õ–ò –ù–ê–ü–ò–®–ò–¢–ï –°–í–û–ô!</div>', unsafe_allow_html=True)
