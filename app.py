import streamlit as st
import pandas as pd
from openai import OpenAI
import os

st.set_page_config(page_title="–£–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç", page_icon="‚ú®", layout="wide")


def local_css(file_name):
    try:
        with open(file_name, "r", encoding="utf-8") as f:
            st.markdown(f"<style>{f.read()}</style>", unsafe_allow_html=True)
    except FileNotFoundError:
        st.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω —Ñ–∞–π–ª —Å—Ç–∏–ª–µ–π style.css!")


GROQ_API_KEY = os.getenv("GROQ_API_KEY")


# --- –ü–û–õ–ù–ê–Ø –ë–ê–ó–ê –ó–ù–ê–ù–ò–ô ---
@st.cache_data
def create_knowledge_base():
    try:
        # –£–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å –∫ –≤–∞—à–µ–º—É —Ñ–∞–π–ª—É
        works_df = pd.read_csv("–ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è–ü.csv").astype(str).fillna('–Ω–µ —É–∫–∞–∑–∞–Ω–æ')
        knowledge_base = ""

        # –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π
        for _, work in works_df.iterrows():
            knowledge_base += f"–ù–∞–∑–≤–∞–Ω–∏–µ:{work['Name']},"
            knowledge_base += f"–±—é–¥–∂–µ—Ç –∏ —Å–±–æ—Ä—ã:{work.get('–ë—é–¥–∂–µ—Ç –∏ —Å–±–æ—Ä—ã', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')},"
            knowledge_base += f"–≤–æ–∑—Ä–∞—Å—Ç:{work.get('–í–æ–∑—Ä–∞—Å—Ç', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')},"
            knowledge_base += f"–≥–æ–¥ –≤—ã–ø—É—Å–∫–∞:{work.get('–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')},"
            knowledge_base += f"–¥–∏—Å–Ω–µ–π–ª–µ–Ω–¥:{work.get('–î–∏—Å–Ω–µ–π–ª–µ–Ω–¥', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')},"
            knowledge_base += f"–∂–∞–Ω—Ä:{work.get('–ñ–∞–Ω—Ä', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')},"
            knowledge_base += f"–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏:{work.get('–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')},"
            knowledge_base += f"–Ω–∞–≥—Ä–∞–¥—ã:{work.get('–ù–∞–≥—Ä–∞–¥—ã', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')},"
            knowledge_base += f"–ø–µ—Ä—Å–æ–Ω–∞–∂–∏:{work.get('–ü–µ—Ä—Å–æ–Ω–∞–∂–∏', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')},"
            knowledge_base += f"–ø–µ—Å–Ω–∏:{work.get('–ü–µ—Å–Ω–∏', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')},"
            knowledge_base += f"–ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:{work.get('–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')},"
            knowledge_base += f"—Ä–µ–π—Ç–∏–Ω–≥:{work.get('–†–µ–π—Ç–∏–Ω–≥', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')},"
            knowledge_base += f"—Å—Ç—É–¥–∏—è:{work.get('–°—Ç—É–¥–∏—è', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')},"
            knowledge_base += f"—Ç–∏–ø:{work.get('–¢–∏–ø', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')};"

        return knowledge_base

    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö: {e}")
        return None


# --- –ò–ù–¢–ï–†–§–ï–ô–° –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
local_css(".streamlit/style.css")

st.title("‚ú® –£–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç Disney ‚ú®")
st.markdown("### –£–∑–Ω–∞–π—Ç–µ –≤—Å—ë –æ –ª—é–±–∏–º—ã—Ö —Ñ–∏–ª—å–º–∞—Ö –∏ –º—É–ª—å—Ç—Ñ–∏–ª—å–º–∞—Ö!")

# –ù–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–µ–π CSV
example_questions = [
    "–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–∑ —Å–ø–∏—Å–∫–∞...",
    "–ö–∞–∫–æ–π –±—é–¥–∂–µ—Ç —É —Ñ–∏–ª—å–º–∞ '–ñ–µ–ª–µ–∑–Ω—ã–π —á–µ–ª–æ–≤–µ–∫'?",
    "–ö–∞–∫–∏–µ —Å–±–æ—Ä—ã —É –º—É–ª—å—Ç—Ñ–∏–ª—å–º–∞ '–•–æ–ª–æ–¥–Ω–æ–µ —Å–µ—Ä–¥—Ü–µ'?",
    "–ö–∞–∫–æ–π —Ñ–∏–ª—å–º —Å–∞–º—ã–π –∫–∞—Å—Å–æ–≤—ã–π?",
    "–°—Ä–∞–≤–Ω–∏ –±—é–¥–∂–µ—Ç—ã '–ò—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä—É—à–µ–∫' –∏ '–ò—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä—É—à–µ–∫ 4'.",
    "–í –∫–∞–∫–æ–º –≥–æ–¥—É –≤—ã—à–µ–ª –º—É–ª—å—Ç—Ñ–∏–ª—å–º '–ë–µ–ª–æ—Å–Ω–µ–∂–∫–∞ –∏ —Å–µ–º—å –≥–Ω–æ–º–æ–≤'?",
    "–ö–∞–∫–∏–µ —Ñ–∏–ª—å–º—ã –≤—ã—à–ª–∏ –≤ 2019 –≥–æ–¥—É?",
    "–ö–∞–∫–æ–π —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π –º—É–ª—å—Ç—Ñ–∏–ª—å–º –≤ –±–∞–∑–µ?",
    "–í –∫–∞–∫–æ–º –î–∏—Å–Ω–µ–π–ª–µ–Ω–¥–µ –µ—Å—Ç—å –∞—Ç—Ç—Ä–∞–∫—Ü–∏–æ–Ω –ø–æ '–ü–∏—Ä–∞—Ç–∞–º –ö–∞—Ä–∏–±—Å–∫–æ–≥–æ –º–æ—Ä—è'?",
    "–ö–∞–∫–∏–µ –∞—Ç—Ç—Ä–∞–∫—Ü–∏–æ–Ω—ã –µ—Å—Ç—å –≤ Magic Kingdom?",
    "–ö–∞–∫–æ–π –∂–∞–Ω—Ä —É —Ñ–∏–ª—å–º–∞ '–ö—Ä—É—ç–ª–ª–∞'?",
    "–ü–µ—Ä–µ—á–∏—Å–ª–∏ –≤—Å–µ —Ñ–∏–ª—å–º—ã –≤ –∂–∞–Ω—Ä–µ '–ú—å—é–∑–∏–∫–ª'.",
    "–í –∫–∞–∫–∏—Ö —Ñ–∏–ª—å–º–∞—Ö —Å–Ω–∏–º–∞–ª—Å—è –î–∂–æ–Ω–Ω–∏ –î–µ–ø–ø?",
    "–ö–∞–∫–∏–µ –∞–∫—Ç–µ—Ä—ã –±—ã–ª–∏ –≤ —Ñ–∏–ª—å–º–µ '–ü–∏—Ä–∞—Ç—ã –ö–∞—Ä–∏–±—Å–∫–æ–≥–æ –º–æ—Ä—è: –ü—Ä–æ–∫–ª—è—Ç–∏–µ –ß—ë—Ä–Ω–æ–π –∂–µ–º—á—É–∂–∏–Ω—ã'?",
    "–ö–∞–∫–∏–µ –Ω–∞–≥—Ä–∞–¥—ã –ø–æ–ª—É—á–∏–ª –º—É–ª—å—Ç—Ñ–∏–ª—å–º '–ö–æ—Ä–æ–ª—å –ª–µ–≤' 1994 –≥–æ–¥–∞?",
    "–ö–∞–∫–æ–π —Ñ–∏–ª—å–º –ø–æ–ª—É—á–∏–ª '–û—Å–∫–∞—Ä' –∑–∞ –ª—É—á—à–∏–µ –∫–æ—Å—Ç—é–º—ã?",
    "–£ –∫–∞–∫–æ–≥–æ —Ñ–∏–ª—å–º–∞ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ '–û—Å–∫–∞—Ä–æ–≤'?",
    "–ö–∞–∫–∏–µ –≥–ª–∞–≤–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –≤ '–†—É—Å–∞–ª–æ—á–∫–µ'?",
    "–í –∫–∞–∫–æ–º —Ñ–∏–ª—å–º–µ –µ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂ –ú–∞–ª–µ—Ñ–∏—Å–µ–Ω—Ç–∞?",
    "–ö–∞–∫–∏–µ –ø–µ—Å–Ω–∏ –µ—Å—Ç—å –≤ –º—É–ª—å—Ç—Ñ–∏–ª—å–º–µ '–ö–æ—Ä–æ–ª—å –ª–µ–≤'?",
    "–ö–∞–∫–∏–µ –ø–µ—Å–Ω–∏ –≤ '–•–æ–ª–æ–¥–Ω–æ–º —Å–µ—Ä–¥—Ü–µ'?",
    "–í –∫–∞–∫–æ–º –º—É–ª—å—Ç—Ñ–∏–ª—å–º–µ –∑–≤—É—á–∏—Ç –ø–µ—Å–Ω—è 'A Whole New World'?",
    "–ö–∞–∫–∞—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É —Ñ–∏–ª—å–º–∞ '–ü–∏—Ä–∞—Ç—ã –ö–∞—Ä–∏–±—Å–∫–æ–≥–æ –º–æ—Ä—è: –ù–∞ –∫—Ä–∞—é —Å–≤–µ—Ç–∞'?",
    "–ö–∞–∫–æ–π —Å–∞–º—ã–π –¥–ª–∏–Ω–Ω—ã–π —Ñ–∏–ª—å–º –≤ —Å–ø–∏—Å–∫–µ?",
    "–ö–∞–∫–æ–π —Å–∞–º—ã–π –∫–æ—Ä–æ—Ç–∫–∏–π –º—É–ª—å—Ç—Ñ–∏–ª—å–º?",
    "–ö–∞–∫–æ–π —Ä–µ–π—Ç–∏–Ω–≥ —É '–ò—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä—É—à–µ–∫'?",
    "–ö–∞–∫–æ–π —Ñ–∏–ª—å–º –∏–º–µ–µ—Ç —Å–∞–º—ã–π –≤—ã—Å–æ–∫–∏–π —Ä–µ–π—Ç–∏–Ω–≥?",
    "–ö–∞–∫–∏–µ –º—É–ª—å—Ç—Ñ–∏–ª—å–º—ã —Å–¥–µ–ª–∞–ª–∞ —Å—Ç—É–¥–∏—è Pixar?",
    "–ö–∞–∫–∞—è —Å—Ç—É–¥–∏—è –≤—ã–ø—É—Å—Ç–∏–ª–∞ —Ñ–∏–ª—å–º '–ñ–µ–ª–µ–∑–Ω—ã–π —á–µ–ª–æ–≤–µ–∫'?",
    "–ü–µ—Ä–µ—á–∏—Å–ª–∏ –≤—Å–µ –∏–≥—Ä–æ–≤—ã–µ —Ñ–∏–ª—å–º—ã (–Ω–µ –º—É–ª—å—Ç—Ñ–∏–ª—å–º—ã)."
]

# --- –ò–ù–¢–ï–†–§–ï–ô–° ---
st.markdown("---")

# –í—ã–±–æ—Ä –≤–æ–ø—Ä–æ—Å–∞
selected_query = st.selectbox(
    "",
    example_questions,
    key="selectbox_query",
    label_visibility="collapsed"
)

# –ü–æ–ª–µ –¥–ª—è —Å–≤–æ–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
custom_query = st.text_input(
    "",
    placeholder="–ò–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å –∑–¥–µ—Å—å...",
    label_visibility="collapsed",
    key="text_input"
)

# –î–æ–±–∞–≤–ª—è–µ–º –±–æ–ª—å—à–∏–π –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–æ–π –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ª–µ–π
st.markdown("<div style='margin-bottom: 5rem;'></div>", unsafe_allow_html=True)

# –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
ask_button = st.button("**–ù–ê–ô–¢–ò –û–¢–í–ï–¢**", use_container_width=True, key="find_answer")

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
if custom_query.strip():
    user_query = custom_query
elif selected_query and selected_query != "–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–∑ —Å–ø–∏—Å–∫–∞...":
    user_query = selected_query
else:
    user_query = ""

knowledge_base_text = create_knowledge_base()
answer_placeholder = st.empty()

if knowledge_base_text and GROQ_API_KEY:
    try:
        client = OpenAI(base_url="https://api.groq.com/openai/v1", api_key=GROQ_API_KEY)
        model_name = "meta-llama/llama-4-scout-17b-16e-instruct"
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞: {e}")
        client = None

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏
    if client and user_query and ask_button:
        with st.spinner(""):
            spinner_html = """
            <div style='text-align: center; padding: 3rem;'>
                <div class='spinner-text'>
                    ‚ú® –ò—â—É –æ—Ç–≤–µ—Ç –≤ –≤–æ–ª—à–µ–±–Ω—ã—Ö –∞—Ä—Ö–∏–≤–∞—Ö –î–∏—Å–Ω–µ–π...
                </div>
            </div>
            """
            st.markdown(spinner_html, unsafe_allow_html=True)

            try:
                prompt = f"""–¢—ã - –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –¢–û–õ–¨–ö–û –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ —Ñ–∏–ª—å–º–∞—Ö –∏ –º—É–ª—å—Ç—Ñ–∏–ª—å–º–∞—Ö –î–∏—Å–Ω–µ–π. 
–ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç –≤ –¥–∞–Ω–Ω—ã—Ö - —Å–æ–æ–±—â–∏ –æ–± —ç—Ç–æ–º –∫—Ä–∞—Ç–∫–æ.

–î–∞–Ω–Ω—ã–µ: {knowledge_base_text}

–í–æ–ø—Ä–æ—Å: {user_query}

–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:
1. –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
2. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç –≤ –¥–∞–Ω–Ω—ã—Ö - —Å–∫–∞–∂–∏ "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –∞—Ä—Ö–∏–≤–µ".
3. –û—Ç–≤–µ—á–∞–π –ø–æ–¥—Ä–æ–±–Ω–æ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
4. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç—ã –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
5. –ù–µ –Ω–∞—á–∏–Ω–∞–π –æ—Ç–≤–µ—Ç —Å —Ñ—Ä–∞–∑ "–í –º–æ–µ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö", "–°–æ–≥–ª–∞—Å–Ω–æ –¥–∞–Ω–Ω—ã–º" - —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ —Å—É—Ç–∏.

–û—Ç–≤–µ—Ç:"""

                response = client.chat.completions.create(
                    model=model_name,
                    messages=[{"role": "user", "content": prompt}],
                    temperature=0.3,
                    max_tokens=2000
                )
                answer = response.choices[0].message.content

                answer_placeholder.markdown(
                    f'<div class="big-success-message">üéâ –ì–û–¢–û–í–û! –í–æ—Ç —á—Ç–æ –º–Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏:</div>',
                    unsafe_allow_html=True
                )
                st.markdown(f'<div class="user-question">–í–∞—à –≤–æ–ø—Ä–æ—Å: {user_query}</div>', unsafe_allow_html=True)
                st.markdown("---")
                st.markdown(
                    f'<div class="big-answer-text">{answer}</div>',
                    unsafe_allow_html=True
                )

            except Exception as e:
                answer_placeholder.markdown(
                    f'<div class="big-error-message">‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}</div>',
                    unsafe_allow_html=True
                )
    elif not user_query and ask_button:
        answer_placeholder.markdown(
            '<div class="big-warning-message">‚ö†Ô∏è –ü–û–ñ–ê–õ–£–ô–°–¢–ê, –í–´–ë–ï–†–ò–¢–ï –í–û–ü–†–û–° –ò–õ–ò –ù–ê–ü–ò–®–ò–¢–ï –°–í–û–ô!</div>',
            unsafe_allow_html=True
        )
else:
    if not GROQ_API_KEY:
        st.markdown(
            '<div class="big-error-message">‚ùå –ö–ª—é—á Groq API –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è.</div>',
            unsafe_allow_html=True
        )
    if not knowledge_base_text:
        st.markdown(
            '<div class="big-error-message">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É –∑–Ω–∞–Ω–∏–π.</div>',
            unsafe_allow_html=True
        )